var sqlite3=require("sqlite3").verbose(),db=new sqlite3.Database(":memory:");db.run("CREATE TABLE IF NOT EXISTS rooms (room_id TEXT, usr1 TEXT, usr2 TEXT)");db.run("CREATE TABLE IF NOT EXISTS bells (bell_id TEXT, usr TEXT)");var http=require("http").Server(),io=require("socket.io")(http,{transports:["polling","websocket"],pingTimeout:59E3,pingInterval:23E3,closeTimeout:864E5});
io.on("connection",function(b){b.on("leave",function(a){db.prepare("DELETE FROM rooms WHERE room_id = ?").run(a);b.leave(a);io.to(a).emit("leave",a)});b.on("setbell",function(a){db.each("SELECT usr FROM bells WHERE bell_id = '"+a+"' LIMIT 1",function(d,c){db.prepare("UPDATE bells SET usr = ? WHERE bell_id = ?").run(b.id,a);io.to(b.id).emit("bell_ok",a)},function(d,c){0==c&&(db.prepare("INSERT OR REPLACE INTO bells (bell_id, usr) VALUES (?, ?)").run(a,b.id),io.to(b.id).emit("bell_ok",a))})});b.on("bell",
function(a){db.each("SELECT usr FROM bells WHERE bell_id = '"+a+"' LIMIT 1",function(d,c){b.id!=c.usr&&io.to(c.usr).emit("bell",a);io.to(b.id).emit("bell_ok",a)},function(d,c){0==c&&io.to(b.id).emit("bell_ok",a)})});b.on("create or join",function(a){db.each("SELECT * FROM rooms WHERE room_id = '"+a+"' AND usr1 != '"+b.id+"' AND (usr2 != '"+b.id+"' OR usr2 = '')",function(d,c){""==c.usr2?(db.prepare("UPDATE rooms SET usr2 = ? WHERE room_id = ?").run(b.id,a),io.to(b.id).emit("joined",a),io.to(c.usr1).emit("join",
a),b.join(a)):(db.prepare("DELETE FROM rooms WHERE room_id = ?").run(a),io.to(b.id).emit("full",a))},function(d,c){0==c&&(db.prepare("INSERT OR REPLACE INTO rooms (room_id, usr1, usr2) VALUES (?, ?, ?)").run(a,b.id,""),io.to(b.id).emit("created",a),b.join(a))})});b.on("candidate_msg",function(a){db.each("SELECT * FROM rooms WHERE usr1 = '"+b.id+"' OR usr2 = '"+b.id+"' LIMIT 1",function(d,c){b.id==c.usr1?io.to(c.usr2).emit("candidate_msg",a):io.to(c.usr1).emit("candidate_msg",a)},function(a,b){})});
b.on("message",function(a){db.each("SELECT * FROM rooms WHERE usr1 = '"+b.id+"' OR usr2 = '"+b.id+"' LIMIT 1",function(d,c){b.id==c.usr1?io.to(c.usr2).emit("message",a):io.to(c.usr1).emit("message",a)},function(a,b){})});b.on("chat message",function(a){db.each("SELECT * FROM rooms WHERE usr1 = '"+b.id+"' OR usr2 = '"+b.id+"' LIMIT 1",function(b,c){io.to(c.room_id).emit("chat message",a)},function(a,c){0==c&&io.to(b.id).emit("chat message","Noch keine Verbindung vorhanden!")})});b.on("pong",function(a){"1"!=
a&&io.to(b.id).emit("ping",a)})});setTimeout(sendHeartbeat,37E3);function sendHeartbeat(){io.sockets.emit("ping","1");setTimeout(sendHeartbeat,37E3)}http.listen(3E3,function(){});